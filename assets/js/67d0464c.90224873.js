"use strict";(globalThis.webpackChunkpathling_site=globalThis.webpackChunkpathling_site||[]).push([[9839],{4705:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"server/operations/import","title":"Import","description":"The import operation allows FHIR data to be imported into the server from external sources such as S3, HDFS, or local filesystem.","source":"@site/docs/server/operations/import.md","sourceDirName":"server/operations","slug":"/server/operations/import","permalink":"/docs/server/operations/import","draft":false,"unlisted":false,"editUrl":"https://github.com/aehrc/pathling/tree/main/site/docs/server/operations/import.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"description":"The import operation allows FHIR data to be imported into the server from external sources such as S3, HDFS, or local filesystem."},"sidebar":"server","previous":{"title":"Getting started","permalink":"/docs/server/getting-started"},"next":{"title":"Import (ping and pull)","permalink":"/docs/server/operations/import-pnp"}}');var s=r(4848),i=r(8453);const o={sidebar_position:1,description:"The import operation allows FHIR data to be imported into the server from external sources such as S3, HDFS, or local filesystem."},d="Import",a={},l=[{value:"Supported formats",id:"supported-formats",level:2},{value:"Supported URL schemes",id:"supported-url-schemes",level:2},{value:"Asynchronous processing",id:"asynchronous-processing",level:2},{value:"Request",id:"request",level:2},{value:"JSON manifest format",id:"json-manifest-format",level:3},{value:"Manifest fields",id:"manifest-fields",level:4},{value:"FHIR Parameters format",id:"fhir-parameters-format",level:3},{value:"Parameters",id:"parameters",level:4},{value:"Import modes",id:"import-modes",level:2},{value:"Response",id:"response",level:2},{value:"Python example",id:"python-example",level:2},{value:"Import client",id:"import-client",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"import",children:"Import"})}),"\n",(0,s.jsx)(n.p,{children:"This operation allows FHIR R4 data to be imported into the server, making it\navailable for query via other operations. Links to retrieve the data are\nprovided rather than sending the data inline within the request itself,\nallowing for large data sets to be imported efficiently."}),"\n",(0,s.jsx)(n.h2,{id:"supported-formats",children:"Supported formats"}),"\n",(0,s.jsx)(n.p,{children:"The following source formats are supported:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Format"}),(0,s.jsx)(n.th,{children:"MIME type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"NDJSON"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"application/fhir+ndjson"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://hl7.org/fhir/R4/nd-json.html",children:"FHIR Newline Delimited JSON"})," format"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Parquet"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"application/vnd.apache.parquet"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://parquet.apache.org/",children:"Apache Parquet"})," conforming to the ",(0,s.jsx)(n.a,{href:"../../libraries/io/schema",children:"Pathling schema"})]})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"supported-url-schemes",children:"Supported URL schemes"}),"\n",(0,s.jsx)(n.p,{children:"Pathling supports retrieval of files from the following URL schemes:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://aws.amazon.com/s3/",children:"Amazon S3"})," (",(0,s.jsx)(n.code,{children:"s3a://"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://hadoop.apache.org/docs/r1.2.1/hdfs_design.html",children:"HDFS"})," (",(0,s.jsx)(n.code,{children:"hdfs://"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Local filesystem (",(0,s.jsx)(n.code,{children:"file://"}),")"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Authentication is supported for S3. Import sources must be explicitly\nwhitelisted within the configuration for security reasons."}),"\n",(0,s.jsx)(n.h2,{id:"asynchronous-processing",children:"Asynchronous processing"}),"\n",(0,s.jsxs)(n.p,{children:["The import operation requires\nthe ",(0,s.jsx)(n.a,{href:"https://hl7.org/fhir/R4/async.html",children:"Asynchronous Request Pattern"}),". Add a\n",(0,s.jsx)(n.code,{children:"Prefer: respond-async"})," header to your request to initiate asynchronous\nprocessing. A ",(0,s.jsx)(n.code,{children:"202 Accepted"})," response will be returned with a ",(0,s.jsx)(n.code,{children:"Content-Location"}),"\nheader indicating the URL of the status endpoint."]}),"\n",(0,s.jsxs)(n.p,{children:["Poll the status endpoint to check progress. When the job is complete, the\nresponse will include a ",(0,s.jsx)(n.code,{children:"Location"})," header pointing to the final result."]}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant C as Client\n    participant P as Pathling\n    C->>P: POST /$import (Prefer: respond-async)\n    P--\x3e>C: 202 Accepted + Content-Location\n    loop Poll for status\n        C->>P: GET [status URL]\n        P--\x3e>C: 202 Accepted (in progress)\n    end\n    C->>P: GET [status URL]\n    P--\x3e>C: 200 OK + result"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"POST [FHIR endpoint]/$import\n"})}),"\n",(0,s.jsx)(n.h2,{id:"request",children:"Request"}),"\n",(0,s.jsx)(n.p,{children:"The import operation supports two request formats:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"JSON manifest format"})," - Aligned with\nthe ",(0,s.jsx)(n.a,{href:"https://github.com/smart-on-fhir/bulk-import",children:"SMART Bulk Data Import"}),"\nspecification"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"FHIR Parameters format"})," - Standard FHIR Parameters resource"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"json-manifest-format",children:"JSON manifest format"}),"\n",(0,s.jsxs)(n.p,{children:["Send a request with ",(0,s.jsx)(n.code,{children:"Content-Type: application/json"})," containing a JSON manifest:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "inputFormat": "application/fhir+ndjson",\n    "input": [\n        {\n            "type": "Patient",\n            "url": "s3a://my-bucket/fhir/Patient.ndjson"\n        },\n        {\n            "type": "Observation",\n            "url": "s3a://my-bucket/fhir/Observation.ndjson"\n        }\n    ],\n    "saveMode": "overwrite"\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"manifest-fields",children:"Manifest fields"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Field"}),(0,s.jsx)(n.th,{children:"Cardinality"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"inputFormat"})}),(0,s.jsx)(n.td,{children:"1..1"}),(0,s.jsxs)(n.td,{children:["The MIME type of the source files. See ",(0,s.jsx)(n.a,{href:"#supported-formats",children:"Supported formats"}),"."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input"})}),(0,s.jsx)(n.td,{children:"1..*"}),(0,s.jsx)(n.td,{children:"An array of input file specifications."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input.type"})}),(0,s.jsx)(n.td,{children:"1..1"}),(0,s.jsx)(n.td,{children:"The FHIR resource type contained in the file."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input.url"})}),(0,s.jsx)(n.td,{children:"1..1"}),(0,s.jsx)(n.td,{children:"The URL where the source file can be retrieved."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"saveMode"})}),(0,s.jsx)(n.td,{children:"0..1"}),(0,s.jsxs)(n.td,{children:["The import mode. See ",(0,s.jsx)(n.a,{href:"#import-modes",children:"Import modes"}),". Defaults to ",(0,s.jsx)(n.code,{children:"overwrite"}),"."]})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"fhir-parameters-format",children:"FHIR Parameters format"}),"\n",(0,s.jsxs)(n.p,{children:["Send a request with ",(0,s.jsx)(n.code,{children:"Content-Type: application/fhir+json"})," containing a FHIR\nParameters resource:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "inputFormat",\n            "valueCoding": {\n                "code": "application/fhir+ndjson"\n            }\n        },\n        {\n            "name": "saveMode",\n            "valueCoding": {\n                "code": "overwrite"\n            }\n        },\n        {\n            "name": "input",\n            "part": [\n                {\n                    "name": "resourceType",\n                    "valueCoding": {\n                        "code": "Patient"\n                    }\n                },\n                {\n                    "name": "url",\n                    "valueUrl": "s3a://my-bucket/fhir/Patient.ndjson"\n                }\n            ]\n        },\n        {\n            "name": "input",\n            "part": [\n                {\n                    "name": "resourceType",\n                    "valueCoding": {\n                        "code": "Observation"\n                    }\n                },\n                {\n                    "name": "url",\n                    "valueUrl": "s3a://my-bucket/fhir/Observation.ndjson"\n                }\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"parameters",children:"Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Name"}),(0,s.jsx)(n.th,{children:"Cardinality"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"inputFormat"})}),(0,s.jsx)(n.td,{children:"0..1"}),(0,s.jsx)(n.td,{children:"Coding"}),(0,s.jsxs)(n.td,{children:["The format of the source files. Defaults to ",(0,s.jsx)(n.code,{children:"application/fhir+ndjson"}),"."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"saveMode"})}),(0,s.jsx)(n.td,{children:"0..1"}),(0,s.jsx)(n.td,{children:"Coding"}),(0,s.jsxs)(n.td,{children:["The import mode. See ",(0,s.jsx)(n.a,{href:"#import-modes",children:"Import modes"}),". Defaults to ",(0,s.jsx)(n.code,{children:"overwrite"}),"."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input"})}),(0,s.jsx)(n.td,{children:"1..*"}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Contains parts describing each input file."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input.resourceType"})}),(0,s.jsx)(n.td,{children:"1..1"}),(0,s.jsx)(n.td,{children:"Coding"}),(0,s.jsx)(n.td,{children:"The FHIR resource type contained in the file."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"input.url"})}),(0,s.jsx)(n.td,{children:"1..1"}),(0,s.jsx)(n.td,{children:"url"}),(0,s.jsx)(n.td,{children:"The URL where the source file can be retrieved."})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"import-modes",children:"Import modes"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Mode"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"overwrite"})}),(0,s.jsx)(n.td,{children:"All existing resources of the specified type are deleted and replaced with the contents of the source file. This is the default."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"merge"})}),(0,s.jsx)(n.td,{children:"Existing resources are matched with resources in the source file based on their ID. Existing resources are updated and new resources are added as appropriate."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"append"})}),(0,s.jsx)(n.td,{children:"Resources in the source file are added without modifying any existing resources."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ignore"})}),(0,s.jsx)(n.td,{children:"If the resource type already exists, the source file is ignored. Otherwise, the resources are added."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"error"})}),(0,s.jsx)(n.td,{children:"If the resource type already exists, an error is raised. Otherwise, the resources are added."})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"response",children:"Response"}),"\n",(0,s.jsx)(n.p,{children:"On successful completion, the operation returns a FHIR Parameters resource:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "transactionTime",\n            "valueInstant": "2025-01-15T10:30:00.000Z"\n        },\n        {\n            "name": "request",\n            "valueUrl": "https://pathling.example.com/fhir/$import"\n        },\n        {\n            "name": "output",\n            "part": [\n                {\n                    "name": "inputUrl",\n                    "valueUrl": "s3a://my-bucket/fhir/Patient.ndjson"\n                }\n            ]\n        },\n        {\n            "name": "output",\n            "part": [\n                {\n                    "name": "inputUrl",\n                    "valueUrl": "s3a://my-bucket/fhir/Observation.ndjson"\n                }\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"python-example",children:"Python example"}),"\n",(0,s.jsx)(n.p,{children:"The following Python script demonstrates how to invoke the import operation with\nasynchronous polling."}),"\n",(0,s.jsxs)(n.p,{children:["Run the script using ",(0,s.jsx)(n.a,{href:"https://docs.astral.sh/uv/",children:"uv"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"uv run import_client.py\n"})}),"\n",(0,s.jsx)(n.h3,{id:"import-client",children:"Import client"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'#!/usr/bin/env python3\n# /// script\n# requires-python = ">=3.10"\n# dependencies = ["requests"]\n# ///\n"""Demonstrates invoking the $import operation with async polling."""\n\nimport time\nimport requests\n\nBASE_URL = "https://pathling.example.com/fhir"\nSOURCES = [\n    ("Patient", "s3a://my-bucket/fhir/Patient.ndjson"),\n    ("Observation", "s3a://my-bucket/fhir/Observation.ndjson"),\n    ("Condition", "s3a://my-bucket/fhir/Condition.ndjson"),\n]\n\n\ndef build_parameters():\n    """Build a FHIR Parameters request body."""\n    parameters = [\n        {"name": "inputFormat", "valueCoding": {"code": "application/fhir+ndjson"}},\n        {"name": "saveMode", "valueCoding": {"code": "overwrite"}}\n    ]\n    for resource_type, url in SOURCES:\n        parameters.append({\n            "name": "input",\n            "part": [\n                {"name": "resourceType", "valueCoding": {"code": resource_type}},\n                {"name": "url", "valueUrl": url}\n            ]\n        })\n    return {"resourceType": "Parameters", "parameter": parameters}\n\n\ndef poll_job(status_url, timeout=3600):\n    """Poll the job status endpoint until completion."""\n    start = time.time()\n    interval = 2.0\n\n    while time.time() - start < timeout:\n        response = requests.get(status_url, headers={"Accept": "application/fhir+json"})\n\n        if response.status_code == 200:\n            print("Import completed successfully")\n            return response.json()\n        elif response.status_code == 202:\n            progress = response.headers.get("X-Progress", "unknown")\n            print(f"In progress: {progress}")\n            time.sleep(interval)\n            interval = min(interval * 1.5, 30.0)\n        else:\n            response.raise_for_status()\n\n    raise TimeoutError(f"Import timed out after {timeout} seconds")\n\n\ndef main():\n    """Execute the import operation."""\n    import_url = f"{BASE_URL}/$import"\n    headers = {\n        "Content-Type": "application/fhir+json",\n        "Accept": "application/fhir+json",\n        "Prefer": "respond-async"\n    }\n\n    print(f"Initiating import at {import_url}")\n    response = requests.post(import_url, json=build_parameters(), headers=headers)\n\n    if response.status_code == 202:\n        status_url = response.headers.get("Content-Location")\n        print(f"Job accepted, polling {status_url}")\n        result = poll_job(status_url)\n        print(f"Result: {result}")\n    else:\n        response.raise_for_status()\n\n\nif __name__ == "__main__":\n    main()\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>d});var t=r(6540);const s={},i=t.createContext(s);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);