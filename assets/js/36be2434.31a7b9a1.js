"use strict";(globalThis.webpackChunkpathling_site=globalThis.webpackChunkpathling_site||[]).push([[9708],{9799(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"server/operations/view-run","title":"Run view","description":"The view run operation executes a ViewDefinition against FHIR data and returns tabular results in NDJSON or CSV format.","source":"@site/docs/server/operations/view-run.md","sourceDirName":"server/operations","slug":"/server/operations/view-run","permalink":"/docs/server/operations/view-run","draft":false,"unlisted":false,"editUrl":"https://github.com/aehrc/pathling/tree/main/site/docs/server/operations/view-run.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7,"description":"The view run operation executes a ViewDefinition against FHIR data and returns tabular results in NDJSON or CSV format."},"sidebar":"server","previous":{"title":"Batch","permalink":"/docs/server/operations/batch"},"next":{"title":"Export view","permalink":"/docs/server/operations/view-export"}}');var t=i(4848),s=i(8453);const a={sidebar_position:7,description:"The view run operation executes a ViewDefinition against FHIR data and returns tabular results in NDJSON or CSV format."},o="Run view",c={},d=[{value:"Endpoint",id:"endpoint",level:2},{value:"Parameters",id:"parameters",level:2},{value:"Request format",id:"request-format",level:2},{value:"Response formats",id:"response-formats",level:2},{value:"NDJSON",id:"ndjson",level:3},{value:"CSV",id:"csv",level:3},{value:"ViewDefinition structure",id:"viewdefinition-structure",level:2},{value:"Inline resources",id:"inline-resources",level:2},{value:"Filtering",id:"filtering",level:2},{value:"Patient filter",id:"patient-filter",level:3},{value:"Group filter",id:"group-filter",level:3},{value:"Time filter",id:"time-filter",level:3},{value:"Python example",id:"python-example",level:2},{value:"View run client",id:"view-run-client",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"run-view",children:"Run view"})}),"\n",(0,t.jsxs)(n.p,{children:["This operation executes a\n",(0,t.jsx)(n.a,{href:"https://build.fhir.org/ig/FHIR/sql-on-fhir-v2/StructureDefinition-ViewDefinition.html",children:"ViewDefinition"}),"\nagainst FHIR data and returns the results as tabular data. This implementation\nfollows the\n",(0,t.jsx)(n.a,{href:"https://build.fhir.org/ig/FHIR/sql-on-fhir-v2/OperationDefinition-ViewDefinitionRun.html",children:"SQL on FHIR specification"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"endpoint",children:"Endpoint"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"POST [base]/$viewdefinition-run\n"})}),"\n",(0,t.jsx)(n.h2,{id:"parameters",children:"Parameters"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Name"}),(0,t.jsx)(n.th,{children:"Cardinality"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"viewResource"})}),(0,t.jsx)(n.td,{children:"1..1"}),(0,t.jsx)(n.td,{children:"Resource"}),(0,t.jsx)(n.td,{children:"The ViewDefinition resource."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"_format"})}),(0,t.jsx)(n.td,{children:"0..1"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsxs)(n.td,{children:["Output format. Accepts ",(0,t.jsx)(n.code,{children:"application/x-ndjson"})," (default) or ",(0,t.jsx)(n.code,{children:"text/csv"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"header"})}),(0,t.jsx)(n.td,{children:"0..1"}),(0,t.jsx)(n.td,{children:"boolean"}),(0,t.jsxs)(n.td,{children:["Include header row in CSV output. Defaults to ",(0,t.jsx)(n.code,{children:"true"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"_limit"})}),(0,t.jsx)(n.td,{children:"0..1"}),(0,t.jsx)(n.td,{children:"integer"}),(0,t.jsx)(n.td,{children:"Maximum number of rows to return."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"patient"})}),(0,t.jsx)(n.td,{children:"0..*"}),(0,t.jsx)(n.td,{children:"id"}),(0,t.jsx)(n.td,{children:"Filter to resources for the specified patient(s)."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"group"})}),(0,t.jsx)(n.td,{children:"0..*"}),(0,t.jsx)(n.td,{children:"id"}),(0,t.jsx)(n.td,{children:"Filter to resources for patients in the specified Group(s)."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"_since"})}),(0,t.jsx)(n.td,{children:"0..1"}),(0,t.jsx)(n.td,{children:"instant"}),(0,t.jsxs)(n.td,{children:["Only include resources where ",(0,t.jsx)(n.code,{children:"meta.lastUpdated"})," is at or after this time."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"resource"})}),(0,t.jsx)(n.td,{children:"0..*"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Inline FHIR resources as JSON strings. When provided, these are used instead of the server's stored data."})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"request-format",children:"Request format"}),"\n",(0,t.jsx)(n.p,{children:"The operation accepts a FHIR Parameters resource with the ViewDefinition passed\nas a nested resource:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'POST [base]/$viewdefinition-run HTTP/1.1\nContent-Type: application/fhir+json\nAccept: application/x-ndjson\n\n{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "viewResource",\n            "resource": {\n                "resourceType": "ViewDefinition",\n                "name": "patient_demographics",\n                "resource": "Patient",\n                "status": "active",\n                "select": [\n                    {\n                        "column": [\n                            {\n                                "name": "id",\n                                "path": "id"\n                            }\n                        ]\n                    },\n                    {\n                        "column": [\n                            {\n                                "name": "family",\n                                "path": "name.first().family"\n                            }\n                        ]\n                    },\n                    {\n                        "column": [\n                            {\n                                "name": "given",\n                                "path": "name.first().given.first()"\n                            }\n                        ]\n                    }\n                ]\n            }\n        }\n    ]\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"response-formats",children:"Response formats"}),"\n",(0,t.jsx)(n.p,{children:"The response uses HTTP chunked transfer encoding, allowing clients to process\nresults incrementally as they arrive rather than waiting for the complete\nresponse. This is particularly useful for large result sets."}),"\n",(0,t.jsx)(n.h3,{id:"ndjson",children:"NDJSON"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"_format"})," is ",(0,t.jsx)(n.code,{children:"application/x-ndjson"})," (the default), the response is\nnewline-delimited JSON with one row per line:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'Content-Type: application/x-ndjson\n\n{"id":"patient-1","family":"Smith","given":"John"}\n{"id":"patient-2","family":"Jones","given":"Jane"}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"csv",children:"CSV"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"_format"})," is ",(0,t.jsx)(n.code,{children:"text/csv"}),", the response is comma-separated values:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Content-Type: text/csv\n\nid,family,given\npatient-1,Smith,John\npatient-2,Jones,Jane\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Set ",(0,t.jsx)(n.code,{children:"header=false"})," to exclude the header row."]}),"\n",(0,t.jsx)(n.h2,{id:"viewdefinition-structure",children:"ViewDefinition structure"}),"\n",(0,t.jsx)(n.p,{children:"A ViewDefinition specifies which resource type to query and how to extract\ncolumns. Here is a more readable example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "ViewDefinition",\n    "name": "patient_demographics",\n    "resource": "Patient",\n    "status": "active",\n    "select": [\n        {\n            "column": [\n                {\n                    "name": "id",\n                    "path": "id"\n                }\n            ]\n        },\n        {\n            "column": [\n                {\n                    "name": "family",\n                    "path": "name.first().family"\n                }\n            ]\n        },\n        {\n            "column": [\n                {\n                    "name": "given",\n                    "path": "name.first().given.first()"\n                }\n            ]\n        },\n        {\n            "column": [\n                {\n                    "name": "gender",\n                    "path": "gender"\n                }\n            ]\n        },\n        {\n            "column": [\n                {\n                    "name": "birth_date",\n                    "path": "birthDate"\n                }\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"path"})," values use ",(0,t.jsx)(n.a,{href:"https://hl7.org/fhirpath/",children:"FHIRPath"})," expressions to\nextract data from resources."]}),"\n",(0,t.jsx)(n.h2,{id:"inline-resources",children:"Inline resources"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"resource"})," parameter allows you to execute a ViewDefinition against\nprovided FHIR resources instead of the server's stored data. This is useful for\ntesting ViewDefinitions or processing resources without importing them."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "viewResource",\n            "resource": {\n                "resourceType": "ViewDefinition",\n                "...": "..."\n            }\n        },\n        {\n            "name": "resource",\n            "valueString": "{\\"resourceType\\":\\"Patient\\",\\"id\\":\\"test-1\\",\\"name\\":[{\\"family\\":\\"Smith\\"}]}"\n        },\n        {\n            "name": "resource",\n            "valueString": "{\\"resourceType\\":\\"Patient\\",\\"id\\":\\"test-2\\",\\"name\\":[{\\"family\\":\\"Jones\\"}]}"\n        }\n    ]\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"filtering",children:"Filtering"}),"\n",(0,t.jsx)(n.h3,{id:"patient-filter",children:"Patient filter"}),"\n",(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.code,{children:"patient"})," parameter to restrict results to resources associated with\nspecific patients:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "viewResource",\n            "resource": {\n                "resourceType": "ViewDefinition",\n                "...": "..."\n            }\n        },\n        {\n            "name": "patient",\n            "valueId": "patient-123"\n        },\n        {\n            "name": "patient",\n            "valueId": "patient-456"\n        }\n    ]\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"group-filter",children:"Group filter"}),"\n",(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.code,{children:"group"})," parameter to restrict results to resources for patients who are\nmembers of the specified Group:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "viewResource",\n            "resource": {\n                "resourceType": "ViewDefinition",\n                "...": "..."\n            }\n        },\n        {\n            "name": "group",\n            "valueId": "cohort-study-group"\n        }\n    ]\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"time-filter",children:"Time filter"}),"\n",(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"_since"})," to only include resources updated after a specific time:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "resourceType": "Parameters",\n    "parameter": [\n        {\n            "name": "viewResource",\n            "resource": {\n                "resourceType": "ViewDefinition",\n                "...": "..."\n            }\n        },\n        {\n            "name": "_since",\n            "valueInstant": "2024-01-01T00:00:00Z"\n        }\n    ]\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"python-example",children:"Python example"}),"\n",(0,t.jsx)(n.p,{children:"The following Python script demonstrates the view run operation."}),"\n",(0,t.jsxs)(n.p,{children:["Run the script using ",(0,t.jsx)(n.a,{href:"https://docs.astral.sh/uv/",children:"uv"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"uv run view_run_client.py\n"})}),"\n",(0,t.jsx)(n.h3,{id:"view-run-client",children:"View run client"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'#!/usr/bin/env python3\n# /// script\n# requires-python = ">=3.10"\n# dependencies = ["requests"]\n# ///\n"""Demonstrates the $viewdefinition-run operation."""\n\nimport json\nimport requests\n\nBASE_URL = "https://pathling.example.com/fhir"\n\n\ndef create_patient_view():\n    """Create a ViewDefinition for Patient demographics."""\n    return {\n        "resourceType": "ViewDefinition",\n        "name": "patient_demographics",\n        "resource": "Patient",\n        "status": "active",\n        "select": [\n            {"column": [{"name": "id", "path": "id"}]},\n            {"column": [{"name": "family", "path": "name.first().family"}]},\n            {"column": [\n                {"name": "given", "path": "name.first().given.first()"}]},\n            {"column": [{"name": "gender", "path": "gender"}]},\n            {"column": [{"name": "birth_date", "path": "birthDate"}]},\n        ],\n    }\n\n\ndef run_view(view_definition, output_format="ndjson", limit=None):\n    """Execute a ViewDefinition and return the results."""\n    url = f"{BASE_URL}/$viewdefinition-run"\n\n    # Build FHIR Parameters resource.\n    parameters = {\n        "resourceType": "Parameters",\n        "parameter": [\n            {"name": "viewResource", "resource": view_definition}\n        ],\n    }\n\n    if output_format == "csv":\n        parameters["parameter"].append(\n            {"name": "_format", "valueString": "text/csv"}\n        )\n    else:\n        parameters["parameter"].append(\n            {"name": "_format", "valueString": "application/x-ndjson"}\n        )\n\n    if limit:\n        parameters["parameter"].append(\n            {"name": "_limit", "valueInteger": limit}\n        )\n\n    # Set Accept header based on format.\n    accept = "text/csv" if output_format == "csv" else "application/x-ndjson"\n\n    headers = {\n        "Content-Type": "application/fhir+json",\n        "Accept": accept,\n    }\n\n    response = requests.post(url, json=parameters, headers=headers, stream=True)\n    response.raise_for_status()\n\n    return response\n\n\ndef run_view_with_inline_resources(view_definition, resources):\n    """Execute a ViewDefinition against inline resources."""\n    url = f"{BASE_URL}/$viewdefinition-run"\n\n    parameters = {\n        "resourceType": "Parameters",\n        "parameter": [\n            {"name": "viewResource", "resource": view_definition},\n            {"name": "_format", "valueString": "application/x-ndjson"},\n        ],\n    }\n\n    # Add inline resources.\n    for resource in resources:\n        parameters["parameter"].append(\n            {"name": "resource", "valueString": json.dumps(resource)}\n        )\n\n    headers = {\n        "Content-Type": "application/fhir+json",\n        "Accept": "application/x-ndjson",\n    }\n\n    response = requests.post(url, json=parameters, headers=headers, stream=True)\n    response.raise_for_status()\n\n    return response\n\n\ndef main():\n    """Execute the view run operation."""\n    view = create_patient_view()\n\n    print("Running ViewDefinition against server data...")\n    print("-" * 50)\n\n    response = run_view(view, output_format="ndjson", limit=10)\n\n    for line in response.iter_lines(decode_unicode=True):\n        if line:\n            row = json.loads(line)\n            print(\n                f"Patient: {row.get(\'id\')} - {row.get(\'given\')} {row.get(\'family\')}")\n\n    print("-" * 50)\n    print("\\nRunning ViewDefinition with inline resources...")\n    print("-" * 50)\n\n    # Test with inline resources.\n    test_patients = [\n        {\n            "resourceType": "Patient",\n            "id": "inline-1",\n            "name": [{"family": "Smith", "given": ["John"]}],\n            "gender": "male",\n            "birthDate": "1980-01-15",\n        },\n        {\n            "resourceType": "Patient",\n            "id": "inline-2",\n            "name": [{"family": "Jones", "given": ["Jane"]}],\n            "gender": "female",\n            "birthDate": "1990-06-20",\n        },\n    ]\n\n    response = run_view_with_inline_resources(view, test_patients)\n\n    for line in response.iter_lines(decode_unicode=True):\n        if line:\n            row = json.loads(line)\n            print(\n                f"Patient: {row.get(\'id\')} - {row.get(\'given\')} {row.get(\'family\')}")\n\n    print("-" * 50)\n    print("Done!")\n\n\nif __name__ == "__main__":\n    main()\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453(e,n,i){i.d(n,{R:()=>a,x:()=>o});var r=i(6540);const t={},s=r.createContext(t);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);