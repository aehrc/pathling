"use strict";(globalThis.webpackChunkpathling_site=globalThis.webpackChunkpathling_site||[]).push([[2448],{7792(e,n,t){t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"libraries/running-queries","title":"Running SQL on FHIR views","description":"The Pathling library can be used to query datasets of FHIR resources using SQL on FHIR views. This is useful for creating tabular views of FHIR data for use in analytic tools.","source":"@site/docs/libraries/running-queries.md","sourceDirName":"libraries","slug":"/libraries/running-queries","permalink":"/docs/libraries/running-queries","draft":false,"unlisted":false,"editUrl":"https://github.com/aehrc/pathling/tree/main/site/docs/libraries/running-queries.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"description":"The Pathling library can be used to query datasets of FHIR resources using SQL on FHIR views. This is useful for creating tabular views of FHIR data for use in analytic tools."},"sidebar":"libraries","previous":{"title":"Parquet specification","permalink":"/docs/libraries/io/schema"},"next":{"title":"Terminology functions","permalink":"/docs/libraries/terminology"}}');var a=t(4848),i=t(8453),s=t(1470),o=t(9365);const l={sidebar_position:3,description:"The Pathling library can be used to query datasets of FHIR resources using SQL on FHIR views. This is useful for creating tabular views of FHIR data for use in analytic tools."},c="Running SQL on FHIR views",u={},d=[];function h(e){const n={a:"a",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"running-sql-on-fhir-views",children:"Running SQL on FHIR views"})}),"\n","\n",(0,a.jsx)(n.p,{children:"The Pathling library leverages the SQL on FHIR specification to provide a way to\nproject FHIR data into easy-to-use tabular forms."}),"\n",(0,a.jsx)(n.p,{children:"Once you have transformed your FHIR data into tabular views, you can choose to\nkeep it in a Spark dataframe and continue to work with in Apache Spark, or\nexport it to Python or R dataframes or a variety of different file formats for\nuse in the tool of your choice."}),"\n",(0,a.jsxs)(s.A,{children:[(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from pathling import PathlingContext\n\npc = PathlingContext.create()\ndata = pc.read.ndjson("/some/file/location")\n\nresult = data.view(\n    resource="Patient",\n    select=[\n        {"column": [{"path": "getResourceKey()", "name": "patient_id"}]},\n        {\n            "forEach": "address",\n            "column": [\n                {"path": "line.join(\'\\\\n\')", "name": "street"},\n                {"path": "use", "name": "use"},\n                {"path": "city", "name": "city"},\n                {"path": "postalCode", "name": "zip"},\n            ],\n        },\n    ],\n)\n\ndisplay(result)\n'})})}),(0,a.jsx)(o.A,{value:"r",label:"R",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-r",children:'library(pathling)\n\npc <- pathling_connect()\ndata <- pc %>% pathling_read_ndjson("/some/file/location")\n\nresult <- data %>% ds_view(\n        resource = "Patient",\n        select = list(\n                list(\n                        column = list(\n                                list(path = "getResourceKey()", name = "patient_id")\n                        )\n                ),\n                list(\n                        forEach = "address",\n                        column = list(\n                                list(path = "line.join(\'\\\\n\')", name = "street"),\n                                list(path = "use", name = "use"),\n                                list(path = "city", name = "city"),\n                                list(path = "postalCode", name = "zip")\n                        )\n                )\n        )\n)\n\nresult %>% show()\n'})})}),(0,a.jsx)(o.A,{value:"java",label:"Java",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'package au.csiro.pathling.examples;\n\nimport static au.csiro.pathling.views.FhirView.column;\nimport static au.csiro.pathling.views.FhirView.columns;\nimport static au.csiro.pathling.views.FhirView.forEach;\n\nimport au.csiro.pathling.library.PathlingContext;\nimport au.csiro.pathling.library.io.source.NdjsonSource;\nimport au.csiro.pathling.views.FhirView;\nimport org.apache.spark.sql.Dataset;\nimport org.apache.spark.sql.Row;\n\nclass MyApp {\n\n    public static void main(String[] args) {\n        PathlingContext pc = PathlingContext.create();\n        NdjsonSource data = pc.read()\n                .ndjson("/some/file/location");\n\n        FhirView view = FhirView.ofResource("Observation")\n                .select(\n                        columns(\n                                column("patient_id", "getResourceKey()")\n                        ),\n                        forEach("code.coding",\n                                column("code_system", "system"),\n                                column("code_code", "code"),\n                                column("code_display", "display")\n                        )\n                ).build();\n\n        Dataset<Row> result = data.view(view).execute();\n\n        result.show();\n    }\n}\n'})})}),(0,a.jsx)(o.A,{value:"scala",label:"Scala",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import au.csiro.pathling.library.PathlingContext\nimport au.csiro.pathling.library.io.source.NdjsonSource\nimport au.csiro.pathling.views.FhirView\nimport au.csiro.pathling.views.FhirView._\nimport org.apache.spark.sql.{Dataset, Row, SparkSession}\n\nval pc = PathlingContext.create()\nval data: NdjsonSource = pc.read()\n        .ndjson("/some/file/location")\n\nval view: FhirView = FhirView.ofResource("Observation")\n        .select(\n            columns(\n                column("patient_id", "getResourceKey()")\n            ),\n            forEach("code.coding",\n                column("code_system", "system"),\n                column("code_code", "code"),\n                column("code_display", "display")\n            ),\n        ).build()\n\nval result: Dataset[Row] = data.view(view).execute()\n\nresult.show()\n'})})})]}),"\n",(0,a.jsx)(n.p,{children:"The result of this query would look something like this:"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"patient_id"}),(0,a.jsx)(n.th,{children:"street"}),(0,a.jsx)(n.th,{children:"use"}),(0,a.jsx)(n.th,{children:"city"}),(0,a.jsx)(n.th,{children:"zip"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"1"}),(0,a.jsx)(n.td,{children:"398 Kautzer Walk Suite 62"}),(0,a.jsx)(n.td,{children:"home"}),(0,a.jsx)(n.td,{children:"Barnstable"}),(0,a.jsx)(n.td,{children:"02675"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"1"}),(0,a.jsx)(n.td,{children:"186 Nitzsche Forge"}),(0,a.jsx)(n.td,{children:"work"}),(0,a.jsx)(n.td,{children:"Revere"}),(0,a.jsx)(n.td,{children:"02151"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"2"}),(0,a.jsx)(n.td,{children:"1087 Quitzon Club"}),(0,a.jsx)(n.td,{children:"home"}),(0,a.jsx)(n.td,{children:"Plymouth"}),(0,a.jsx)(n.td,{children:"NULL"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"3"}),(0,a.jsx)(n.td,{children:"442 Bruen Arcade"}),(0,a.jsx)(n.td,{children:"home"}),(0,a.jsx)(n.td,{children:"Nantucket"}),(0,a.jsx)(n.td,{children:"NULL"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"4"}),(0,a.jsx)(n.td,{children:"858 Miller Junction Apt 61"}),(0,a.jsx)(n.td,{children:"work"}),(0,a.jsx)(n.td,{children:"Brockton"}),(0,a.jsx)(n.td,{children:"02301"})]})]})]}),"\n",(0,a.jsxs)(n.p,{children:["For a more comprehensive example demonstrating SQL on FHIR queries with multiple\nviews, complex transformations and joins, see\nthe ",(0,a.jsx)(n.a,{href:"/docs/libraries/examples/prostate-cancer",children:"SQL on FHIR example"}),"."]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},9365(e,n,t){t.d(n,{A:()=>s});t(6540);var r=t(4164);const a="tabItem_Ymn6";var i=t(4848);function s({children:e,hidden:n,className:t}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,r.A)(a,t),hidden:n,children:e})}},1470(e,n,t){t.d(n,{A:()=>k});var r=t(6540),a=t(4164),i=t(7559),s=t(3104),o=t(6347),l=t(205),c=t(7485),u=t(1682),d=t(679);function h(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,r.useMemo)(()=>{const e=n??function(e){return h(e).map(({props:{value:e,label:n,attributes:t,default:r}})=>({value:e,label:n,attributes:t,default:r}))}(t);return function(e){const n=(0,u.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}function f({queryString:e=!1,groupId:n}){const t=(0,o.W6)(),a=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(a),(0,r.useCallback)(e=>{if(!a)return;const n=new URLSearchParams(t.location.search);n.set(a,e),t.replace({...t.location,search:n.toString()})},[a,t])]}function b(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,i=p(e),[s,o]=(0,r.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:i})),[c,u]=f({queryString:t,groupId:a}),[h,b]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,a]=(0,d.Dv)(n);return[t,(0,r.useCallback)(e=>{n&&a.set(e)},[n,a])]}({groupId:a}),g=(()=>{const e=c??h;return m({value:e,tabValues:i})?e:null})();(0,l.A)(()=>{g&&o(g)},[g]);return{selectedValue:s,selectValue:(0,r.useCallback)(e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),b(e)},[u,b,i]),tabValues:i}}var g=t(2303);const x="tabList__CuJ",v="tabItem_LNqP";var j=t(4848);function y({className:e,block:n,selectedValue:t,selectValue:r,tabValues:i}){const o=[],{blockElementScrollPositionUntilNextRender:l}=(0,s.a_)(),c=e=>{const n=e.currentTarget,a=o.indexOf(n),s=i[a].value;s!==t&&(l(n),r(s))},u=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,j.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":n},e),children:i.map(({value:e,label:n,attributes:r})=>(0,j.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:u,onClick:c,...r,className:(0,a.A)("tabs__item",v,r?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function w({lazy:e,children:n,selectedValue:t}){const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===t);return e?(0,r.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,j.jsx)("div",{className:"margin-top--md",children:i.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function R(e){const n=b(e);return(0,j.jsxs)("div",{className:(0,a.A)(i.G.tabs.container,"tabs-container",x),children:[(0,j.jsx)(y,{...n,...e}),(0,j.jsx)(w,{...n,...e})]})}function k(e){const n=(0,g.A)();return(0,j.jsx)(R,{...e,children:h(e.children)},String(n))}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>o});var r=t(6540);const a={},i=r.createContext(a);function s(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);