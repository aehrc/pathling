<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2023 Commonwealth Scientific and Industrial Research
  ~ Organisation (CSIRO) ABN 41 687 119 230.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<FindBugsFilter
    xmlns="https://github.com/spotbugs/filter/3.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="https://github.com/spotbugs/filter/3.0.0
                        https://raw.githubusercontent.com/spotbugs/spotbugs/master/spotbugs/etc/findbugsfilter.xsd">

  <!-- Exclude generated code directories. -->
  <Match>
    <Source name="~.*/generated/.*"/>
  </Match>
  <Match>
    <Source name="~.*/generated-sources/.*"/>
  </Match>

  <!-- Suppress PREDICTABLE_RANDOM for Strings.randomAlias(). ThreadLocalRandom is flagged
       by FindSecBugs as non-cryptographic, but column aliases don't require crypto security. -->
  <Match>
    <Class name="au.csiro.pathling.utilities.Strings"/>
    <Method name="randomAlias"/>
    <Bug pattern="PREDICTABLE_RANDOM"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP warnings in Scala code. Scala case classes and Spark Catalyst
       expressions intentionally expose their fields for pattern matching and serialisation. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress HE_EQUALS_NO_HASHCODE for Spark Catalyst expression classes. These follow
       Spark's internal patterns where equals is used for expression comparison but hashCode
       is not typically needed. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="HE_EQUALS_NO_HASHCODE"/>
  </Match>

  <!-- Suppress synchronisation warnings in Scala singleton objects. Scala generates
       thread-safe lazy initialisers that SpotBugs doesn't understand. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="SSD_DO_NOT_USE_INSTANCE_LOCK_ON_SHARED_STATIC_DATA"/>
  </Match>

  <!-- Suppress serialisation warnings for Spark Catalyst expression classes. These classes
       follow Spark's serialisation patterns which differ from standard Java conventions. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="SE_NO_SERIALVERSIONID"/>
  </Match>
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="SE_TRANSIENT_FIELD_NOT_RESTORED"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP warnings for Lombok-generated code in configuration classes.
       These use Lombok @Data/@Getter/@Setter which generates standard accessors. -->
  <Match>
    <Class name="au.csiro.pathling.config.EncodingConfiguration"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.config.EncodingConfiguration"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.config\.EncodingConfiguration\$.*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for encoder classes. These intentionally share mutable state
       like FhirContext which is designed to be reused across the application. -->
  <Match>
    <Class name="au.csiro.pathling.encoders.FhirEncoders"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.encoders.FhirEncoders"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.encoders.FhirEncoderBuilder"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.encoders.FhirEncodersKey"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.encoders.FhirEncodersKey"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for HAPI FHIR resource classes. These follow HAPI FHIR's
       conventions for resource classes with standard getter/setter patterns. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.encoders\.ViewDefinitionResource.*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.encoders\.ViewDefinitionResource.*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress null pointer warnings in Scala code. Scala's pattern matching and Option
       handling generates code that SpotBugs incorrectly flags as null dereferences. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="NP_NULL_ON_SOME_PATH"/>
  </Match>

  <!-- Suppress naming convention warnings for Scala package objects. These are named
       "package" or "package$" which is Scala's convention, not a Java naming violation. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="NM_CLASS_NAMING_CONVENTION"/>
  </Match>

  <!-- Suppress serialisation warnings for Scala schema traversal classes. These hold
       HAPI FHIR definition objects that are not serialisable but don't need to be. -->
  <Match>
    <Source name="~.*\.scala"/>
    <Bug pattern="SE_BAD_FIELD"/>
  </Match>

  <!-- Suppress MS_EXPOSE_REP for Ucum singleton. The UcumEssenceService is intentionally
       shared as a singleton since it's thread-safe and expensive to create. -->
  <Match>
    <Class name="au.csiro.pathling.encoders.terminology.ucum.Ucum"/>
    <Bug pattern="MS_EXPOSE_REP"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for all configuration classes. These use Lombok @Data/@Builder
       which generates standard accessors. Config objects are intentionally mutable. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.config\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.config\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for FHIR utility classes and value objects. These work with
       HAPI FHIR types which are intentionally mutable by design. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.fhir\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.fhir\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.fhir\..*"/>
    <Bug pattern="CT_CONSTRUCTOR_THROW"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for terminology service classes. These are value objects
       that wrap HAPI FHIR types. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.terminology\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.terminology\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress NP_BOOLEAN_RETURN_NULL for Spark UDF classes. These intentionally return
       null for Boolean results when input is null (SQL three-valued logic). -->
  <Match>
    <Class name="~au\.csiro\.pathling\.sql\.udf\..*"/>
    <Bug pattern="NP_BOOLEAN_RETURN_NULL"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.sql\.udf\..*"/>
    <Bug pattern="CT_CONSTRUCTOR_THROW"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for fhirpath module. This module uses many value objects and
       records that intentionally expose their fields for functional programming patterns. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.fhirpath\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.fhirpath\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.fhirpath\..*"/>
    <Bug pattern="CT_CONSTRUCTOR_THROW"/>
  </Match>

  <!-- Suppress singleton pattern warnings. These classes use Spring-style singleton patterns
       with public constructors to support dependency injection frameworks. -->
  <Match>
    <Bug pattern="SING_SINGLETON_HAS_NONPRIVATE_CONSTRUCTOR"/>
  </Match>

  <!-- Suppress REDOS warnings for FHIR date/time parsing regexes. These regexes parse
       well-defined FHIR date/time formats and are bounded by input validation. The patterns
       only accept valid FHIR datetime strings which have maximum lengths. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.fhirpath\.FhirPath.*"/>
    <Bug pattern="REDOS"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for projection module. This module uses value objects that
       intentionally expose their fields for functional programming patterns. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.projection\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.projection\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for views module. View definition classes follow SQL on FHIR
       conventions with mutable list properties. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.views\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.views\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.views\..*"/>
    <Bug pattern="CT_CONSTRUCTOR_THROW"/>
  </Match>

  <!-- Suppress EI_EXPOSE_REP for library-api module. API classes intentionally expose
       FhirContext and other shared objects. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.library\..*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Class name="~au\.csiro\.pathling\.library\..*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>

  <!-- Suppress REDOS for FileSource. The regex matches simple file extensions and is
       bounded by the file system path length limits. -->
  <Match>
    <Class name="au.csiro.pathling.library.io.source.FileSource"/>
    <Bug pattern="REDOS"/>
  </Match>

  <!-- Suppress all warnings for benchmark module. JMH generates code with intentional
       padding fields and the benchmark state classes are not security-sensitive. -->
  <Match>
    <Class name="~au\.csiro\.pathling\.benchmark\..*"/>
  </Match>

  <!-- Server module suppressions: Spring beans inject dependencies which triggers
       EI_EXPOSE_REP warnings. This is intentional for dependency injection. -->
  <Match>
    <Package name="~au\.csiro\.pathling.*"/>
    <Bug pattern="EI_EXPOSE_REP"/>
  </Match>
  <Match>
    <Package name="~au\.csiro\.pathling.*"/>
    <Bug pattern="EI_EXPOSE_REP2"/>
  </Match>
  <Match>
    <Package name="~au\.csiro\.pathling.*"/>
    <Bug pattern="CT_CONSTRUCTOR_THROW"/>
  </Match>

  <!-- Suppress ImportLock synchronization warning. The lock uses a static boolean
       that is intentionally synchronized at the instance level for simplicity. -->
  <Match>
    <Class name="au.csiro.pathling.operations.bulkimport.ImportLock"/>
    <Bug pattern="SSD_DO_NOT_USE_INSTANCE_LOCK_ON_SHARED_STATIC_DATA"/>
  </Match>

  <!-- Suppress REDOS warnings for server-side regex patterns. These patterns parse
       controlled input from FHIR operations and are bounded by request validation. -->
  <Match>
    <Class name="au.csiro.pathling.operations.bulkimport.ImportPnpExecutor"/>
    <Bug pattern="REDOS"/>
  </Match>
  <Match>
    <Class name="au.csiro.pathling.security.PathlingAuthority"/>
    <Bug pattern="REDOS"/>
  </Match>

  <!-- Suppress redundant null check warnings. These may occur due to defensive
       programming or code patterns that SpotBugs doesn't fully understand. -->
  <Match>
    <Bug pattern="RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE"/>
  </Match>

</FindBugsFilter>
