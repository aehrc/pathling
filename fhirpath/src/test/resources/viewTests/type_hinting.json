{
  "title": "Type hinting with tags",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "123",
      "active": true,
      "name": [
        {
          "family": "Smith",
          "given": [
            "John",
            "1900",
            "3344.60",
            "true",
            "2023-10-01 12:00:00.000Z"
          ]
        }
      ]
    },
    {
      "resourceType": "Observation",
      "id": "Observation/xyz",
      "status": "final",
      "effectivePeriod": {
        "start": "2023-10-01T12:00:00Z",
        "end": "2023-10-02T12:00:00Z"
      },
      "code": {
        "coding": [
          {
            "system": "http://loinc.org",
            "code": "2093",
            "display": "Glucose [Moles/volume] in Blood",
            "userSelected": true
          }
        ],
        "text": "Glucose"
      },
      "valueQuantity": {
        "value": 123.45,
        "unit": "mg/dL"
      },
      "component": [
        {
          "code": {
            "coding": [
              {
                "system": "uuid:type",
                "code": "integer",
                "display": "Integer Type"
              }
            ],
            "text": "integer"
          },
          "valueInteger": 1222
        },
        {
          "code": {
            "coding": [
              {
                "system": "uuid:type",
                "code": "time",
                "display": "Time Type"
              }
            ],
            "text": "time"
          },
          "valueTime": "12:00:00"
        }
      ]
    }
  ],
  "tests": [
    {
      "title": "default mappings for simple types",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "name": "value_empty",
                "path": "{}"
              },
              {
                "name": "value_id",
                "path": "id"
              },
              {
                "name": "value_code",
                "path": "status"
              },
              {
                "name": "value_string",
                "path": "code.text"
              },
              {
                "name": "value_uri",
                "path": "code.coding.first().system"
              },
              {
                "name": "value_boolean",
                "path": "code.coding.first().userSelected"
              },
              {
                "name": "value_integer",
                "path": "component.where(code.text='integer').first().value.ofType(Integer)"
              },
              {
                "name": "value_decimal",
                "path": "value.ofType(Quantity).value"
              },
              {
                "name": "value_dateTime",
                "path": "effectivePeriod.start"
              },
              {
                "name": "value_time",
                "path": "component.where(code.text='time').first().value.ofType(Time)"
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "value_empty": null,
          "value_id": "xyz",
          "value_code": "final",
          "value_string": "Glucose",
          "value_uri": "http://loinc.org",
          "value_boolean": true,
          "value_integer": 1222,
          "value_decimal": "123.450000",
          "value_dateTime": "2023-10-01T12:00:00Z",
          "value_time": "12:00:00"
        }
      ]
    },
    {
      "title": "Runtime evaluation of type hints",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "INT"
                  }
                ]
              },
              {
                "name": "status",
                "path": "active",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "VARCHAR(10)"
                  }
                ]
              },
              {
                "name": "given_as_string",
                "path": "name.given",
                "collection": true,
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ARRAY<VARCHAR(10)>"
                  }
                ]
              },
              {
                "name": "given_as_int",
                "path": "name.given",
                "collection": true,
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ARRAY<INT>"
                  }
                ]
              },
              {
                "name": "given_as_boolean",
                "path": "name.given",
                "collection": true,
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ARRAY<BOOLEAN>"
                  }
                ]
              },
              {
                "name": "given_as_decimal",
                "path": "name.given",
                "collection": true,
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ARRAY<DECIMAL>"
                  }
                ]
              },
              {
                "name": "given_as_timestamp",
                "path": "name.given",
                "collection": true,
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ARRAY<TIMESTAMP>"
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": 123,
          "status": "true",
          "given_as_string": [
            "John",
            "1900",
            "3344.60",
            "true",
            "2023-10-01 12:00:00.000Z"
          ],
          "given_as_int": [
            null,
            1900,
            3344,
            null,
            null
          ],
          "given_as_boolean": [
            null,
            null,
            null,
            true,
            null
          ],
          "given_as_decimal": [
            null,
            1900,
            3344.60,
            null,
            null
          ],
          "given_as_timestamp": [
            null,
            "1900-01-01 00:00:00.0",
            null,
            null,
            "2023-10-01 12:00:00.0"
          ]
        }
      ]
    },
    {
      "title": "CHAR(4) hinting",
      "view": {
        "resource": "Patient",
        "constant": [
          {
            "name": "string_l1",
            "valueString": "a"
          },
          {
            "name": "string_l4",
            "valueString": "abcd"
          },
          {
            "name": "string_l8",
            "valueString": "abcdefgh"
          },
          {
            "name": "bool_false",
            "valueBoolean": false
          }
        ],
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              },
              {
                "name": "string_l1",
                "path": "%string_l1",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "CHAR(4)"
                  }
                ]
              },
              {
                "name": "string_l4",
                "path": "%string_l4",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "CHAR(4)"
                  }
                ]
              },
              {
                "name": "string_l8",
                "path": "%string_l8",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "CHAR(4)"
                  }
                ]
              },
              {
                "name": "bool_false",
                "path": "%bool_false",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "CHAR(4)"
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": "123",
          "string_l1": "a",
          "string_l4": "abcd",
          "string_l8": "abcdefgh",
          "bool_false": "false"
        }
      ]
    },
    {
      "title": "Complex type hinting",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              },
              {
                "name": "effectivePeriod_as_is",
                "path": "effectivePeriod"
              },
              {
                "name": "effectivePeriod_as_timestamp",
                "path": "effectivePeriod",
                "tag": [
                  {
                    "name": "ansi/type",
                    "value": "ROW(id VARCHAR, begin TIMESTAMP, finish TIMESTAMP)"
                  }
                ]
              }
            ]
          }
        ]
      },
      "expectError": true
    }
  ]
}
